name: 'Kernel Signer'
author: 'EyeCantCU'
description: 'Signs kernel in image via Podman'
inputs:
  image:
    description: 'Image containing kernel'
    required: true
  privkey:
    description: 'Private key, path to private key, or URL to retrieve private key'
    default: './certs/private_key.priv.test'
    required: true
  pubkey:
    description: 'Public key, path to public key, or URL to retrieve public key'
    default: './certs/public_key.der.test'
    required: true
runs:
  using: "composite"
  steps:
    - name: Sign kernel
      shell: bash
      run: |
        CONTAINER_ID=$(podman container list | grep ${{ inputs.image }} | awk '{ print $1 }')
        if [[ -z $CONTAINER_ID ]]; then
          CONTAINER_ID=$(podman run -d ${{ inputs.image }})
        fi
        podman exec -e PRIVKEY=${{ inputs.privkey }} -e PUBKEY=${{ inputs.pubkey }} -w $PWD $CONTAINER_ID ./sign-kernel.sh
        buildah commit $CONTAINER_ID ${{ inputs.image }}
